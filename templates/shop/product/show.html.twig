{# templates/shop/product/show.html.twig #}
{% extends 'base.html.twig' %}
{% set current_page = 'product' %}

{% block header_logo %}
    <img class="logo-alimosmose"  src="{{ asset('build/images/logo-boutique.png') }}" alt="logo boutique"/>
{% endblock %}

{% block title %} Détail produit{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('product') }}
{% endblock %}

{% block body %}
    <div role="main">
        <div class="icones-user-shop">
            <a href="{{ path('app_shop_cart') }}" aria-label="Voir mon panier">
                <i class="fa-solid fa-bag-shopping fa-2xl" style="color: #a0ab81;"></i>
            </a>

            <div class="user-menu-wrapper">
                {% if app.user %}
                    <button id="user-menu-toggle" class="user-icon-button"  aria-haspopup="true" aria-expanded="false" aria-label="Mon compte">
                        <i class="fa-solid fa-user fa-2xl" style="color: #a0ab81;"></i>
                    </button>
                    <div id="user-menu" class="user-dropdown">
                        <form method="post" action="{{ path('app_logout') }}">
                            <button type="submit" class="user-menu-link">Se déconnecter</button>
                        </form>
                    </div>
                {% else %}
                    <a href="{{ path('app_login') }}" aria-label="Connexion">
                        <i class="fa-solid fa-user fa-2xl" style="color: #a0ab81;"></i>
                    </a>
                {% endif %}
            </div>
        </div>

        <a href="{{ path('app_product_list') }}">
            <img src="{{ asset('build/images/back_arrow.png') }}" alt="Flèche retour" class="back_arrow">
        </a>

        {% if product.isNew %}
            <span class="badge badge-success" aria-hidden="true" style="margin-left:10px; font-size:0.8em; padding:5px 8px;">Nouveau</span>
        {% endif %}

        <section class="background-beige">
            <h1 class="h2-right">{{ product.name }}</h1>
            <div class="descriptif-flex">
                <div class="product-slider">
                    {# IMAGES #}
                    {% set images = product.images %}
                    {% set firstImage = images|first %}
                    <div class="main-image-container">
                        {% if firstImage %}
                            <img id="main-product-image"  loading="lazy" src="{{ asset('img/products/' ~ firstImage.filename) }}" alt="{{ product.name }}">
                        {% endif %}
                    </div>

                    {# MINIATURES #}
                    {% if images|length > 1 %}
                        <div class="thumbnail-container" role="list">
                            {% for image in images %}
                                <img src="{{ asset('img/products/' ~ image.filename) }}" alt="{{ product.name }}" class="thumbnail" data-index="{{ loop.index0 }}" aria-label="Voir l'image {{ loop.index }}">
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% if product.images|length > 1 %}
                        <button id="prev-image" class="slider-arrow" aria-label="Image précédente">&#10094;</button>
                        <button id="next-image" class="slider-arrow" aria-label="Image suivante">&#10095;</button>
                    {% endif %}
                </div>

                <div class="description-contenance">
                    {# --- DESCRIPTION (au-dessus des variantes) --- #}
                    <div class="product-description">
                        {{ product.description|raw }}
                    </div>
                    <br>

                    {# --- Préparer les variants côté Twig et détecter les types présents --- #}
                    {% set variants = product.variants %}
                    {% set hasContenance = false %}
                    {% set hasSize = false %}
                    {% set hasColor = false %}
                    {% for v in variants %}
                        {% if v.contenance is not empty %}{% set hasContenance = true %}{% endif %}
                        {% if v.size is not empty %}{% set hasSize = true %}{% endif %}
                        {% if v.color is not empty %}{% set hasColor = true %}{% endif %}
                    {% endfor %}

                    {# ---------------- Contenance ---------------- #}
                    {% if hasContenance %}
                        <h2 class="contenance">Contenance</h2>
                        <div class="variants-container contenance">
                            {% for variant in variants %}
                                {% if variant.contenance %}
                                    <div class="variant-card" role="button" tabindex="0" aria-pressed="false" aria-disabled="{{ variant.isOutOfStock ? 'true' : 'false' }}" data-variant-id="{{ variant.id }}" data-outofstock="{{ variant.isOutOfStock ? '1' : '0' }}"
                                        {% if product.isOutOfStock or variant.isOutOfStock %}variant-unavailable{% endif %}"
                                         data-csrf="{{ csrf_token('cart_add_' ~ variant.id) }}"
                                         data-variant-id="{{ variant.id }}"
                                         data-outofstock="{{ variant.isOutOfStock ? '1' : '0' }}"
                                         {% if product.isOutOfStock or variant.isOutOfStock %}title="Indisponible"{% endif %}
                                    >
                                        {{ variant.contenance }} - {{ variant.getPriceEuros()|number_format(2, ',', ' ') }} €
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        {# Prix unique affiché sous le nom du produit #}
                        {% if variants|length > 0 %}
                            <p><strong>Prix : {{ variants[0].getPriceEuros()|number_format(2, ',', ' ') }} €</strong></p>

                        {% endif %}
                    {% endif %}

                    {# ---------------- Taille ---------------- #}
                    {% if hasSize %}
                        <h3>Taille</h3>
                        <div class="variants-container size" id="sizes-container">
                            {% set seenSizes = [] %}
                            {% for v in variants %}
                                {% if v.size %}
                                    {% if v.size not in seenSizes %}
                                        {% set seenSizes = seenSizes|merge([v.size]) %}

                                        {# find an example variant for this size to check outOfStock #}
                                        {% set example = null %}
                                        {% for ev in variants %}
                                            {% if ev.size == v.size and example is null %}
                                                {% set example = ev %}
                                            {% endif %}
                                        {% endfor %}

                                        <div class="variant-card size-card {% if example.isOutOfStock %}variant-unavailable{% endif %}"
                                             role="button"
                                             tabindex="0"
                                             aria-pressed="false"
                                             aria-disabled="{{ example.isOutOfStock ? 'true' : 'false' }}"
                                             data-size="{{ v.size }}"
                                             data-outofstock="{{ example.isOutOfStock ? '1' : '0' }}">
                                            {{ v.size }}
                                        </div>
                                    {% endif %}
                                {% endif %}

                            {% endfor %}
                        </div>
                    {% endif %}

                    {# ---------------- Couleur ---------------- #}
                    {% if hasColor %}
                        <h3>Couleur</h3>
                        <div class="variants-container color" id="colors-container">
                            {% set seenColors = [] %}
                            {% for v in variants %}
                                {% if v.color %}
                                    {% if v.color not in seenColors %}
                                        {% set seenColors = seenColors|merge([v.color]) %}

                                        {% set exampleC = null %}
                                        {% for ev in variants %}
                                            {% if ev.color == v.color and exampleC is null %}
                                                {% set exampleC = ev %}
                                            {% endif %}
                                        {% endfor %}

                                        <div class="variant-card color-card {% if exampleC.isOutOfStock %}variant-unavailable{% endif %}"
                                             role="button"
                                             tabindex="0"
                                             aria-pressed="false"
                                             aria-disabled="{{ exampleC.isOutOfStock ? 'true' : 'false' }}"
                                             data-color="{{ v.color }}"
                                             data-outofstock="{{ exampleC.isOutOfStock ? '1' : '0' }}">
                                            {{ v.color }}
                                        </div>
                                    {% endif %}
                                {% endif %}

                            {% endfor %}
                        </div>
                    {% endif %}

                    {# ---------------- Préparer le tableau JS côté Twig (url + token garantis) ---------------- #}
                    {% set variants_for_js = [] %}
                    {% for v in variants %}
                        {% set item = {
                            'id': v.id,
                            'size': v.size|default(''),
                            'color': v.color|default(''),
                            'contenance': v.contenance|default(''),
                            'outOfStock': v.isOutOfStock ? true : false,
                            'price': v.getPriceEuros(),
                            'url': path('app_shop_cart_add', {'variantId': v.id}),
                            'token': csrf_token('cart_add_' ~ v.id)
                        } %}
                        {% set variants_for_js = variants_for_js|merge([item]) %}
                    {% endfor %}



                    {# ---------------- Formulaire d'ajout au panier ---------------- #}
                    <div class="btn-container">
                        <form id="add-to-cart-form" method="post" action="#">
                            <input type="hidden" name="_token" id="csrf-token" value="">
                            <input type="hidden" name="variantId" id="selected-variant-id" value="">

                            {% if product.isCustomizable %}
                                <h3>Prénom de votre animal</h3>
                                <input type="text" name="customText" id="customText" maxlength="10" required placeholder="10 caractères maximum">
                            {% endif %}

                            {% if not product.isOutOfStock %}
                                <button type="submit" class="btn-add-cart">
                                    Ajouter au panier
                                </button>
                            {% endif %}
                        </form>

                        <div id="variant-error" style="color:#c0392b;margin-top:8px;display:none;" aria-live="polite">
                             Merci de choisir une combinaison taille/couleur avant d'ajouter au panier.
                        </div>

                        {% if product.isOutOfStock %}
                            <span class="rupture-stock-badge" style="background-color:#c0392b;color:white;padding:5px 10px;border-radius:5px;display:inline-block;margin-top:5px;" aria-live="polite">
                                Produit en rupture de stock
                            </span>
                        {% endif %}
                    </div>

                </div> {# /description-contenance #}
            </div> {# /descriptif-flex #}

        </section>


        <section class="composition-flex">
            {% if product.composition is not empty %}
                <h3>Composition</h3>
                <p>{{ product.composition }}</p>
            {% endif %}

            {% if product.analyticsComponents is not empty %}
                <h3>Composants analytiques</h3>
                <p>{{ product.analyticsComponents }}</p>
            {% endif %}

            {% if product.nutritionnalAdditive is not empty %}
                <h3>Additifs nutritionnels par kg</h3>
                <p>{{ product.nutritionnalAdditive }}</p>
            {% endif %}
        </section>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        window.PRODUCT_VARIANTS = {{ variants_for_js|json_encode|raw }};
    </script>
    <script src="{{ asset('build/js/select-product.js') }}"></script>
{% endblock %}


